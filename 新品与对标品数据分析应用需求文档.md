新品与对标品数据分析应用需求文档
1. 项目背景
本项目旨在开发一个数据分析应用，用于处理并整合从SCM系统导出的新品申报数据及其对应的对标品数据。通过对这些数据的清洗、映射和合并，最终生成一份结构清晰、重点突出的综合分析报告（目标表），为业务决策提供数据支持。
2. 核心功能需求
应用需要实现以下核心功能：读取多个数据源，根据预设的映射关系和业务逻辑对数据进行处理，最终生成一个目标Excel文件，并提供一个可在局域网内访问的用户友好界面。
3. 数据源 (输入)
应用需要处理以下三个数据源：
表别名	数据内容	格式/来源	描述
table1	映射关系表	用户上传的Excel文件	该表定义了目标表字段与table2、table3原始字段的对应关系。包含三列，顺序固定为：目标字段名、table2字段名、table3字段名。系统需缓存最新上传的版本。
table2	新品申报数据	用户上传的Excel文件	从SCM系统导出的新品申报原始数据。
table3	对标品数据	后台SQL文件	数据通过执行项目后台自带的 对标品.sql 文件中的SQL查询语句从数据库中获取。该文件无需用户上传。
4. 数据处理逻辑与实现需求
4.1. 生成 map_table2 (新品数据映射)
•	目标: 将 table2 (新品申报数据) 的列名根据 table1 的映射规则，转换为目标表的标准字段名。
•	实现逻辑:
1.	读取 table1 和 table2。
2.	遍历 table1 中的映射关系。
3.	将 table2 中所有与 table1 的 “table2字段名” 列匹配的列，重命名为对应的 “目标字段名”。
4.	生成中间表 map_table2。
4.2. 生成 map_table3 (对标品数据筛选与映射)
•	目标: 对 table3 (对标品数据) 进行有效样本筛选，然后将其列名根据 table1 的映射规则转换为目标表的标准字段名。
•	实现逻辑:
1.	样本筛选 (前置步骤):
	在进行字段映射之前，必须先对 table3 的数据行进行过滤。
	筛选规则: 保留 table3 中的某一行，当且仅当该行的 【通用名】 或 【三级大类】 的值存在于 table2 的对应列中。这一步是为了确保只分析与已申报新品相关的对标品。
2.	字段映射:
	对经过筛选后的 table3 数据，执行与 map_table2 相同的字段映射逻辑。
	将 table3 中所有与 table1 的 “table3字段名” 列匹配的列，重命名为对应的 “目标字段名”。
	生成中间表 map_table3。
4.3. 生成 target_table (目标表合并与格式化)
•	目标: 将 map_table2 和 map_table3 合并，并按照指定规则排序和格式化，生成最终的目标表。
•	实现逻辑:
1.	数据合并: 将 map_table2 和 map_table3 进行纵向合并（Union All），生成 target_table。
2.	数据排序:
	首先，基于字段 【三级大类】 对整个 target_table 进行分组。
	在每个分组内部，调整数据行的顺序，规则如下：
	所有源自 map_table2 (新品数据) 的行排在前面。
	所有源自 map_table3 (对标品数据) 的行排在后面。
	源自 map_table3 的行内部，需要按照 【销售额】 字段进行 降序 排列。
3.	格式化:
	在生成的最终Excel文件中，所有源自 map_table2 (新品数据) 的数据行，需要设置 黄色背景色 以高亮显示。
5. 输出要求
•	文件格式: target_table 必须以 Excel (.xlsx) 格式输出。
•	内容: 包含经过合并、排序和格式化后的最终数据。
•	交互: 应用界面需提供一个明确的下载按钮，允许用户下载生成的Excel文件。
6. 技术栈与项目结构
•	开发语言: Python
•	核心框架: Streamlit
•	项目结构:
o	建议采用模块化的项目结构，将数据加载、数据处理、UI展示等逻辑分离到不同的文件中。
o	例如：
o	project_root/
o	├── main.py             # Streamlit应用主入口
o	├── data_loader.py      # 负责加载Excel和SQL文件数据
o	├── data_processor.py   # 核心数据处理逻辑（映射、筛选、合并、排序）
o	├── ui_components.py    # Streamlit界面组件（文件上传、下载按钮等）
o	└── assets/
o	    └── 对标品.sql      # 对标品数据查询脚本 (后台文件)

7. 界面与交互（建议）
•	文件上传:
o	提供 新品申报数据.xlsx 的文件上传组件。
o	提供 映射关系表.xlsx 的文件上传组件。应用应缓存用户上传的最新版本，并在界面上提示当前使用的映射表信息（如：文件名、上传时间），用户可以选择上传新版本以覆盖旧版本。
•	执行按钮: 提供一个“开始分析”或类似的按钮来触发整个数据处理流程。
•	结果展示: 在数据处理完成后，可以在界面上预览 target_table 的前几行数据。
•	结果下载: 在结果展示区域旁边，提供一个“下载分析结果”的按钮。
•	状态提示: 在数据处理过程中，应有加载或处理中的状态提示，以提升用户体验。
